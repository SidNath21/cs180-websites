<!DOCTYPE html>
<html>

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title> Fun With Diffusion Models - CS180 </title>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">

    <style>
        .card {
            position: relative;
            overflow: hidden;
        }
        .card-img-top {
            transition: opacity 0.3s ease;
        }
        .card-img-top.gif {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        /* Only apply hover effect to cards with the 'hover-gif' class */
        .card.hover-gif:hover .card-img-top:not(.gif) {
            opacity: 0;
        }
        .card.hover-gif:hover .card-img-top.gif {
            opacity: 1;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hoverGifCards = document.querySelectorAll('.card.hover-gif');
            
            hoverGifCards.forEach(card => {
                const gif = card.querySelector('.card-img-top.gif');
                
                card.addEventListener('mouseenter', function() {
                    // Reset the GIF by reloading it
                    const gifSrc = gif.src;
                    gif.src = '';
                    gif.src = gifSrc;
                });
            });
        });
    </script>

</head>

<body>

    <div class="main-description mt-3">

        <h1 class="display-3 text-center"> CS 180 -- Project 5 </h1>
        <p class="lead text-center fs-3"> Fun With Diffusion Models </p>
        <p class="text-center fs-4"> Siddharth Nath - <span>sidnath@berkeley.edu</span> </p>
        <div style="width: 80%;" class="mx-auto">
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <button class="btn btn-outline-primary me-md-2" type="button"
                    onClick="document.getElementById('image-quilting').scrollIntoView();""> Using the DeepFloyd IF Model </button>
                <button class=" btn btn-outline-primary" type="button"
                    onClick="document.getElementById('neural-style-transfer').scrollIntoView();"> Diffusion Models from
                    Scratch </button>
            </div>
            <hr />
        </div>

    </div>


    <div class="project-body mx-auto" style="width: 80%;">

        <div class="project-overview" id="image-quilting">
            <h1 class="display-5"> Diffusion Project Overview </h1>
            <p class="lead">
                In the first part of this project, I used the <a
                    href="https://huggingface.co/docs/diffusers/api/pipelines/deepfloyd_if">DeepFloyd IF diffusion
                    model</a>, and implement diffusion sampling loops to perform tasks such as inpainting and creating
                optical illusions.
                This project follows the implementation of the paper <a href="https://arxiv.org/pdf/2006.11239">
                    <i>Denoising Diffusion Probabilistic Models</i> </a>
            </p>

            <p class="lead">
                Some of the highlights of this project include:
            <ul>
                <li> <a href="#section_1_7_2" class="section-link"><span
                            class="text-primary-emphasis">Inpainting</span></a> which allows us to modify/edit specific
                    parts of an image </li>
                <li> <a href="#section_1_8" class="section-link"><span class="text-primary-emphasis">Visual
                            Anagrams</span></a> that look different when flipped upside down </li>
                <li> <a href="#section_1_9" class="section-link"><span class="text-primary-emphasis">Hybrid
                            Images</span></a> that look different when viewed from different distances </li>
            </ul>
            </p>
        </div>

        <div class="0">
            <h1 class="display-6"> Part 0: Setting up the DeepFloyd IF Model </h1>
            <p>
                DeepFloyd IF is an open-source text-to-image diffusion model trained by Stability AI that has two
                separate stages. The first stage generates a 64x64 pixel image based on a text prompt. The second stage
                then uses the first stage's output as a starting point and outputs a higher resulution 256x256 pixel
                image.
                It is important to note that the model's text encoder is very large and barely fits on Google Colab's
                free GPU. Therefore, this project uses some precomputed text embeddings so that the model can be run on
                Google Colab.
                <br> <br>
                After setting up the model, I can use the <code>stage_1</code> and <code>stage_2</code> models to sample
                images.
                To sample images from the stage 1 model, I have to pass in a text prompt and the number of inference
                steps. Inference steps indicate how many denoising steps for the model to take; a higher number of
                inference steps correlates to higher image quality at the cost of computational cost.
                For the stage 2 model, I need to pass in the stage 1 output and the number of inference steps.
                <br> <br>
                Here are some examples of the model's output:
            </p>

            <h5> Sample Results from the DeepFloyd IF Model </h5>
            <p> Below I listed the Stage 1 and Stage 2 model outputs for different text prompts and inference steps.
            </p>

            <hr>
            <h6>
                <p class="text-primary-emphasis">Figure 1: An oil painting of a snowy mountain village</p>
            </h6>
            <div class="container grid-container">
                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/snow_stage_1_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (10 inference steps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/snow_stage_2_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (10 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/snow_stage_1_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/snow_stage_2_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-danger">
                TO DO
            </p>

            <hr>
            <h6>
                <p class="text-primary-emphasis">Figure 2: A man wearing a hat</p>
            </h6>

            <div class="container grid-container">

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/man_stage_1_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (10 inferencesteps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/man_stage_2_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (10 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/man_stage_1_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/man_stage_2_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-danger">
                TO DO
            </p>

            <hr>
            <h6>
                <p class="text-primary-emphasis">Figure 3: A rocket ship</p>
            </h6>

            <div class="container grid-container">

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/rocket_stage_1_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (10 inference steps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/rocket_stage_2_steps_10.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (10 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/rocket_stage_1_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 1 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./images/part0/rocket_stage_2_steps_100.png" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Stage 2 (100 inference steps) </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <p class="text-danger">
                TO DO
            </p>

        </div>


        <div class="1">

            <h1 class="display-6"> Part 1: Sampling Loops </h1>
            <p class="">
                In this part of the project, I implemented sampling loops to produce high quality images using the
                pretrained DeepFloyd denoisers.

                Starting with a clean image \(x_0\) at time \(t = 0\), we can iteratively add noise to the image until
                it resembles pure noise \(x_T\) at time \(t = T\).
                For DeepFloyd IF, \(T = 1000\) by default, and the amount of noise added at each timestep is controlled
                by noise coefficients \(\bar{\alpha}_t\).

            <div class="mx-auto w-75">
                <img src="./images/part1/diffusion_models_primer.png" class="img-fluid" alt="Responsive image">
            </div>

            The diffusion models attemps to reverse this process by denoising the image \(x_t\). This can by done by
            training a model that predicts the noise in an image given the timestep \(t\) and the noisy image \(x_t\).
            With such a model, we can either:
            <ul>
                <li> Remove all the noise from the image \(x_T\) to get the original image \(x_0\) -- <a
                        href="#section_1_3" class="section-link"><span class="text-primary">One Step
                            Denoising</span></a> </li>
                <li> Iteratively remove a portion of the noise at each timestep to get a cleaner denoised image
                    \(x_{t-1}\) -- <a href="#section_1_4" class="section-link"><span class="text-primary">Iterative
                            Denoising</span></a> </li>
            </ul>

            To sample images from the model, we can feed in a pure noise image \(x_T\) from a gaussian distribution
            \(\sim \mathcal{N}(0, I)\) and follow the process above.

            </p>

            <div class="1_1">
                <h1 class="display-6"> Part 1.1: Implementing the Forward Process </h1>
                <p class="">
                    The forward process describes the process of adding noise to a clean image \(x_0\) to get a noisy
                    image \(x_t\) at timestep \(t\). This process is defined by:
                    $$ q(x_t|x_0) = \mathcal{N}(x_t; \sqrt{\alpha_t}x_0, (1 - \alpha_t)I) \tag{1} $$
                    Here, the noise is sampled from a Gaussian distribution with mean \(\sqrt{\alpha_t}x_0\) and
                    variance \((1 - \alpha_t)I\).

                    We can rewrite this as:
                    $$ x_t = \sqrt{\bar{\alpha}_t} \cdot x_0 + \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \text{ where }
                    \epsilon \sim \mathcal{N}(0, I) \tag{2} $$

                    The forward process is implemented in the function <kbd>forward()</kbd>.
                    This function takes in an image \(x_0\) and a timestep \(t\), and uses equation (2) to return the
                    noisy image \(x_t\).

                </p>

                <h5> Results </h5>
                <p> Here are some examples of the forward process for different timesteps: </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 4: Forward Process for Berkeley Campanile Image </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Berkeley Campanile (\(t = 0\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_noise_250.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy Campanile (\(t = 250\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_noise_500.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy Campanile (\(t = 500\)) </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_noise_750.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy Campanile (\(t = 750\)) </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>

            <div class="1_2">
                <h1 class="display-6"> Part 1.2: Classical Denoising </h1>
                <p class="">
                    One naive way to denoise an image is to use classical methods such as Gaussian blurring which acts
                    as a low-pass filter.
                    This can be done by convolving the image with a Gaussian kernel.

                    Using a kernel size of 15x15 and a standard deviation recommended by PyTorch's
                    <kbd>gaussian_blur</kbd> function, I attempted to denoise the noisy images from the previous
                    section.
                    The results are shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 5: Classical Denoising for Berkeley Campanile Image </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> Berkeley Campanile (\(t = 0\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_classical_denoise_250.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Blurred Campanile (\(t = 250\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_classical_denoise_500.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Blurred Campanile (\(t = 500\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_classical_denoise_750.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Blurred Campanile (\(t = 750\)) </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>



                <p class="text-danger">
                    TO DO
                </p>

            </div>

            <div class="1_3" id="section_1_3">
                <h1 class="display-6"> Part 1.3: One Step Denoising </h1>
                <p class="">
                    Now, we can use the pretrained DeepFloyd denoiser to denoise the noisy images. The denoiser is a
                    UNet architecture that can be accessed at <code>stage_1.unet</code>. This UNet has already been
                    trained on a large dataset of \( (x_t, t) \) pairs of images, and can be used to recover the
                    Gaussian noise in an image.
                    Something to keep in mind is that the diffusion model expects a text prompt embedding. We end up
                    using a placeholder prompt "a high quality photo" for this part of the project.

                    Rearranging the forward process equation (2), we can solve for \(x_0\) with the noise estimate
                    \(\epsilon\) given by the denoiser UNet:
                    $$ x_0 = \frac{x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon}{\sqrt{\bar{\alpha}_t}} \tag{3} $$

                    The results are shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 6: One Step Denoising for Berkeley Campanile Image </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Berkeley Campanile (\(t = 0\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_one_step_denoise_250.png" class="card-img-top"
                                    alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> One Step Denoised (\(t = 250\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_one_step_denoise_500.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> One Step Denoised (\(t = 500\)) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_one_step_denoise_750.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> One Step Denoised (\(t = 750\)) </p>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>

            <div class="1_4" id="section_1_4">
                <h1 class="display-6"> Part 1.4: Iterative Denoising </h1>
                <p class="">
                    Looking at the results from the previous section, we can see that the denoising is much better than
                    the classical denoising, but still not very good. This is because diffusion models are designed to
                    denoise images iteratively, and not just in one step.
                    To fix this, we could start with a noisy image (\(x_t\)) for \(t = 1000\) and iteratively denoise
                    one step at a time until we get to \(t = 0\). However, this is computationally expensive and not
                    very efficient.

                    Instead, we can skip some steps and use strided timesteps instead. For this project, we use a stride
                    of 30. Starting from \(t = 990\), we can denoise the image for \(t = 960, 930, 900, \ldots, 0\).
                    On the ith denoising step, we have an image \(x_t\) at the timestep
                    <code>strided_timesteps[i]</code>. After one denoising step, we get a slightly cleaner image
                    \(x_{t'}\) (where \(t' < t\)) using the formula: $$ x_{t'}=\frac{\sqrt{\bar{\alpha_{t'}}} \cdot
                        \beta_{t'}}{1 - \bar{\alpha_t}} x_0 + \frac{\sqrt{\alpha_t} (1 - \bar{\alpha_{t'}})}{1 -
                        \bar{\alpha_t}} x_t + v_\sigma \tag{4} $$ <ul>
                        <li> \(x_0\) is our current estimate of the clean image from performing one-step denoising </li>
                        <li> \(x_t\) is our noisy image at timestep \(t\) </li>
                        <li> \(x_{t'}\) is our noisy image at timestep \(t'\) such that \(t' < t\) </li>
                        <li> \( \alpha_t = \frac{\bar{\alpha_{t'}}}{\bar{\alpha_t}} \) </li>
                        <li> \(\beta_{t} = 1 - \alpha_t \) </li>
                        <li> \(v_\sigma\) is the noise estimate from the DeepFloyd denoiser UNet </li>
                        </ul>
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 7: Iterative Denoising for Berkeley Campanile Image </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-2 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/noisy_690.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy \(t = 690\) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/noisy_540.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy \(t = 540\) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/noisy_390.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy \(t = 390\) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/noisy_240.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy \(t = 240\) </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/noisy_90.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Noisy \(t = 90\) </p>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Berkeley Campanile </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_iterative_denoise.png" class="card-img-top"
                                    alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> Iteratively Denoised </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_one_step_denoise.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> One Step Denoised </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/campanile_classical_denoise.png" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Gaussian Denoised </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>

            <div class="1_5" id="section_1_5">
                <h1 class="display-6"> Part 1.5: Diffusion Model Sampling </h1>
                <p class="">

                    Now that we have a function that performs iterative denoising, we can use it to generate images.
                    Instead of passing in a noisy image of a certain photo, we can start with pure noise and iteratively
                    denoise it to generate images from scratch. Passing in the prompt "a high quality photo", I got
                    these results:
                </p>
                <h6>
                    <p class="text-primary-emphasis">Figure 8: Diffusion Model Sampling using the prompt "a high quality
                        photo" </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/high_quality_1.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> High Quality Photo 1 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/high_quality_2.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> High Quality Photo 2 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/high_quality_3.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> High Quality Photo 3 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/high_quality_4.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> High Quality Photo 4 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/high_quality_5.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> High Quality Photo 5 </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>

            <div class="1_6" id="section_1_6">
                <h1 class="display-6"> Part 1.6: Classifier-Free Guidance </h1>
                <p class="">

                    Notice that some of the generated images from the previous part are not very good. To improve image
                    quality (at the expense of image diversity), we can use a technique called Classifier-Free Guidance
                    (CFG).
                    CFG works by calculating two different noise estimates:
                <ul>
                    <li> \( \epsilon_{c} \) is the noise estimate conditioned on a text prompt such as "a high quality
                        photo" </li>
                    <li> \( \epsilon_{u} \) is the unconditional noise estimate </li>
                </ul>

                The final noise estimate is then calculated as:
                $$ \epsilon = \epsilon_{u} + \gamma \cdot (\epsilon_{c} - \epsilon_{u}) \tag{5} $$ where \(\gamma\) is a
                hyperparameter that controls the strength of the guidance.
                When \(\gamma = 0\), we get an unconditional noise estimate, and when \(\gamma = 1\), we get a
                conditional noise estimate. However, when \(\gamma > 1\), the quality of the image drastically improves.

                I used the same prompt "a high quality photo" as before, but with a higher \(\gamma\) value of 7. The
                results are shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 9: Diffusion Model Sampling with CFG </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/cfg_1.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> CFG Sample 1 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/cfg_2.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> CFG Sample 2 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/cfg_3.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> CFG Sample 3 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/cfg_4.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> CFG Sample 4 </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/cfg_5.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> CFG Sample 5 </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>


            </div>

            <div class="1_7" id="section_1_7">
                <h1 class="display-6"> Part 1.7: Image-to-Image Translation </h1>
                <p class="">
                    By taking a real image, adding noise to it, and then denoising it, we end up with an editted image
                    that resembles the original image. The more noise we add, the "larger" the edits will appear.
                    We test this SDEdit algorithm with different levels of noise -- Here are some examples of running
                    the iterative denoising function (with CFG) on varying levels of noise applied to test images;
                    specifically, we use strided timesteps \(i_\text{start} \in \{1, 3, 5, 7, 10, 20\}\):
                </p>
                <h6>
                    <p class="text-primary-emphasis">Figure 10: SDEdit on Berkeley Campanile </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_1.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[1]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_2.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[3]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_3.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[5]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_4.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[7]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_5.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[10]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_6.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[20]</code> </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 11: SDEdit on ... </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_1.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[1]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_2.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[3]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_3.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[5]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_4.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[7]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_5.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[10]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_6.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[20]</code> </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure 12: SDEdit on ... </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_1.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[1]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_2.png" class="card-img-top" alt="Image 1">

                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[3]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_3.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[5]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_4.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[7]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_5.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[10]</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./images/part1/1.7/campanile_SDEdit_6.png" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>strided_timesteps[20]</code> </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h4 class=""> Part 1.7.1: Editing Hand Drawn and Web Images </h4>
                <p class="">
                    The SDEdit algorithm works particularly well with non-realistic image, such as drawings, and
                    projecting it onto the natural image manifold. Below are some examples of this algorithm with
                    nonrealistic images.
                </p>
                <h6>
                    <p class="text-primary-emphasis">Figure 13: SDEdit ... </p>
                </h6>

                <p class="text-danger">
                    TO DO
                </p>

                <h4 class=""> Part 1.7.2: Inpainting </h4>
                <div id="section_1_7_2">
                    <p class="">
                        Following the <a href="https://arxiv.org/pdf/2201.09865">RePaint</a> paper, we can also use the
                        iterative denoising algorithm to inpaint images.
                        Given an image \( x_\text{original} \) and a binary mask \( m \), we can create a new image that
                        has
                        new content in the masked region while preserving the rest of the image.

                        After every iteration of the denoising process, we force the resulting image \( x_t \) to have
                        the
                        same pixels as the original image \( x_\text{original} \) where \( m \) is 0.
                        $$ x_t \leftarrow m x_t + (1 - m) \text{forward}(x_\text{original}, t)$$

                        This ensures that we leave everything inside the edit mask alone, but we replace everything
                        outside
                        the edit mask with our original image -- with the correct amount of noise added for timestep \(
                        t
                        \).

                        Below are some examples of the inpainting results:


                    </p>

                    <h6>
                        <p class="text-primary-emphasis">Figure 14: Impainting Campanile </p>
                    </h6>

                    <div class="container grid-container">

                        <div class="row align-items-center justify-content-center">
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_image.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Berkeley Campanile </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_mask.png" class="card-img-top" alt="Image 1">

                                    <div class="card-body text-center">
                                        <p class="card-text"> Binary Mask </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_to_replace.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Image to Replace </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_inpaint.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Inpainted Image </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-danger">
                        TO DO
                    </p>

                    <h6>
                        <p class="text-primary-emphasis">Figure 14: Impainting ... </p>
                    </h6>

                    <div class="container grid-container">

                        <div class="row align-items-center justify-content-center">
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">

                                    <div class="card-body text-center">
                                        <p class="card-text"> Binary Mask </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Image to Replace </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Inpainted Image </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-danger">
                        TO DO
                    </p>

                    <h6>
                        <p class="text-primary-emphasis">Figure 14: Impainting ... </p>
                    </h6>

                    <div class="container grid-container">

                        <div class="row align-items-center justify-content-center">
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">

                                    <div class="card-body text-center">
                                        <p class="card-text"> Binary Mask </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Image to Replace </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Inpainted Image </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-danger">
                        TO DO
                    </p>

                    <h4 class=""> Part 1.7.3: Text-Conditioned Image-to-image Translation </h4>
                    <p class="">
                        Up until now, we were using the prompt: "a high quality photo". Now, we will do the same thing
                        as
                        the previous section, but guide the projection with language by using more specific custom text
                        prompts.
                        Once again, we can vary the amount of noise we add to the image to control the amount of editing
                        we
                        do. Here we use the same timesteps as before: \(i_\text{start} \in \{1, 3, 5, 7, 10, 20\}\).
                        Below are some examples of the text-conditioned image-to-image translation results:
                    </p>

                    <h6>
                        <p class="text-primary-emphasis">Figure : Campanile as "a rocket ship" </p>
                    </h6>

                    <div class="container grid-container">

                        <div class="row align-items-center justify-content-center">
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/campanile.png" class="card-img-top" alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> Berkeley Campanile </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row align-items-center justify-content-center">
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_1.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[1]</code> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_2.png" class="card-img-top"
                                        alt="Image 1">

                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[3]</code> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_3.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[5]</code> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_4.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[7]</code> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_5.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[10]</code> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                                <div class="card">
                                    <img src="./images/part1/1.7/campanile_rocket_6.png" class="card-img-top"
                                        alt="Image 1">
                                    <div class="card-body text-center">
                                        <p class="card-text"> <code>strided_timesteps[20]</code> </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-danger">
                        TO DO
                    </p>


                </div>
            </div>

            <div class="1_8" id="section_1_8">
                <h1 class="display-6" id="section_1_8"> Part 1.8: Visual Anagrams </h1>
                <p class="">
                    Another interesting application of the diffusion model is to generate visual anagrams. Following
                    the
                    implementation of <a href="https://dangeng.github.io/visual_anagrams/">Visual Anagrams</a>, we
                    can
                    create image that has two different meanings when flipped upside down.
                    To do this, at each iteration of the denoising process we calculate a noise estimate for two
                    different prompts (one for the right side up image and one for the flipped image). Then we
                    average
                    the two noise estimates to get our final noise estimate that we use to denoise the image.

                    The full algorithm is shown below:

                    $$ \epsilon_1 = \text{UNet}(x_t, t, p_1) $$
                    $$ \epsilon_2 = \text{flip}(\text{UNet}(\text{flip}(x_t), t, p_2)) $$
                    $$ \epsilon = (\epsilon_1 + \epsilon_2) / 2 $$

                    Here, UNet is the same DeepFloyd diffusion model UNet from before, flip() is a function that
                    flips
                    the image, and \( p_1 \) and \( p_2 \) are two different text prompt embeddings.
                    Below are some examples of the visual anagrams:


                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure .. </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/campfire.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original">An oil painting of people around a campfire</p>
                                    <p class="anagram-text-flipped">An oil painting of an old man</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/oldman.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original">An oil painting of an old man</p>
                                    <p class="anagram-text-flipped">An oil painting of people around a campfire</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure .. </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original"></p>
                                    <p class="anagram-text-flipped"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original"></p>
                                    <p class="anagram-text-flipped"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original"></p>
                                    <p class="anagram-text-flipped"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <div class="anagram-wrapper">
                                    <img src="./images/part1/1.8/.png" class="card-img-top" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="anagram-text-original"></p>
                                    <p class="anagram-text-flipped"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>


            <div class="1_9" id="section_1_9">
                <h1 class="display-6" id="section_1_9"> Part 1.9: Hybrid Images </h1>
                <p class="">
                    Another interesting application of the diffusion model is to generate hybrid images; these are
                    images whose appearance can change depending on the distance (or size) at which they are viewed.
                    Following the implementation of <a href="https://dangeng.github.io/factorized_diffusion/">Factorized
                        Diffusion</a>, we can create an image that has a different appearance when viewed from
                    different
                    distances.
                    To do this, at each iteration of the denoising process we calculate a noise estimate for two
                    different prompts and combine the low frequencies from one noise estimate with high frequencies
                    of
                    the other.

                    The full algorithm is shown below:

                    $$ \epsilon_1 = \text{UNet}(x_t, t, p_1) $$
                    $$ \epsilon_2 = \text{UNet}(x_t, t, p_2) $$
                    $$ \epsilon = f_\text{lowpass}(\epsilon_1) + f_\text{highpass}(\epsilon_2) $$

                    Here, UNet is the same DeepFloyd diffusion model UNet from before, \(f_\text{lowpass}\) and
                    \(f_\text{highpass}\) are low-pass and high-pass filters respectively, and \(p_1\) and \(p_2\)
                    are
                    two different text prompt embeddings.
                    Below are some examples of hybrid images that look different when viewed from far away versus up
                    close:

                </p>
                <h6>
                    <p class="text-primary-emphasis">Figure .. </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/skull-waterfall.png" class="hybrid-image-small"
                                        alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near">A lithograph of a skull</p>
                                    <p class="hybrid-text-far">A lithograph of a waterfall</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/skull-waterfall.png" class="hybrid-image-large"
                                        alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near">A lithograph of a waterfall</p>
                                    <p class="hybrid-text-far">A lithograph of a skull</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure .. </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/.png" class="hybrid-image-small" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near"></p>
                                    <p class="hybrid-text-far"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/.png" class="hybrid-image-large" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near"></p>
                                    <p class="hybrid-text-far"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure .. </p>
                </h6>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/.png" class="hybrid-image-small" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near"></p>
                                    <p class="hybrid-text-far"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card hybrid-card">
                                <div class="hybrid-image-container">
                                    <img src="./images/part1/1.9/.png" class="hybrid-image-large" alt="Image 1">
                                </div>
                                <div class="card-body text-center">
                                    <p class="hybrid-text-near"></p>
                                    <p class="hybrid-text-far"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-danger">
                    TO DO
                </p>

            </div>

        </div>

        <hr>

        <div class="project-overview" id="neural-style-transfer">
            <h1 class="display-5"> Diffusion Models From Scratch </h1>
            <p class="lead">
                In the second part of this project, I implemented a diffusion model from scratch following the DDPM
                paper. I built a time-conditioned UNet architecture in PyTorch that learns to denoise images by
                predicting the noise added during the forward process. The model was trained on the MNIST dataset to
                generate handwritten digits conditioned on their class labels. This involved implementing both the
                forward process (gradually adding noise to images) and the reverse process (iteratively denoising to
                generate new images).
            </p>

        </div>

        <div class="2">

            <h1 class="display-6"> Part 2: Training a Single-Step Denoising UNet </h1>

            <p class="">
                For this project, we use the MNIST dataset which consists of 28x28 pixel black and white images of
                digits.
                The first step in this project is building a simple one-step denoiser. Given a noisy image \( z \),
                we train a denoiser \( D_\theta \) such that it maps \( z \) to a clean image \( x \).
                Using the L2 loss funciton, we can train the denoiser to minimize the following objective:

                $$ L = \mathbb{E}_{z, x} || D_\theta(z) - x ||^2 $$
            </p>

            <hr>
            <br>


            <div class="2_1" id="section_2_1">

                <h1 class="display-6"> Part 2.1: Implementing the UNet Architecture </h1>

                <p>
                    The architecture I used for this project is a simple UNet that takes in a noisy version of an image
                    and attempts to denoise it.
                    Below is the diagram of the UNet architecture:
                </p>
                <h6>
                    <p class="text-primary-emphasis">Figure : Unconditional UNet Architecture </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/unconditional_unet.png" class="img-fluid" alt="Responsive image">
                </div>

                <br>

                <p>
                    UNet is a type of encoder-decoder network, which means that it has a contracting path (encoder) that
                    reduces the spatial dimensions of the input image, followed by an expanding path (decoder) that
                    restores
                    the spatial dimensions of the image.
                    This architecture consists of different layers and standard PyTorch tensor operations for image
                    processing such as convolutions, max-pooling, and upsampling.
                    A more detailed diagram of these components is show below:
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure : Standard UNet Operations </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/unet_operations.png" class="img-fluid" alt="Responsive image">
                </div>

                <br>

                <p>
                <ul>
                    <li>Conv2d(kernel_size, stride, padding) is <code>nn.Conv2d(kernel_size, stride, padding)</code>
                    </li>
                    <li>BN is <code>nn.BatchNorm2d()</code></li>
                    <li>GELU is <code>nn.GELU()</code></li>
                    <li>ConvTranspose2d(kernel_size, stride, padding) is
                        <code>nn.ConvTranspose2d(kernel_size, stride, padding)</code>
                    </li>
                    <li>AvgPool(kernel_size) is <code>nn.AvgPool2d(kernel_size)</code></li>
                    <li>D is the number of hidden channels and is a hyperparameter that we will set ourselves.</li>
                </ul>
                With these two diagrams, we can implement the UNet architecture in PyTorch and begin training the model.
                </p>
            </div>

            <div class="2_2" id="section_2_2">
                <h1 class="display-6"> Part 2.2: Using the UNet to Train a Denoiser </h1>
                <p class="">
                    To train the UNet, we need to generate a dataset of noisy images and their corresponding clean
                    images \( (z, x) \) where each \( x \) is a clean MNIST digit.
                    We can generate \( z \) by adding noise to \( x \) using the the following noising equation:
                    $$ z = x + \sigma \epsilon \text{ where } \epsilon \sim \mathcal{N}(0, I) $$
                    where \( \epsilon \) is a noise term sampled from a normal distribution.

                    Below visualizes the noising process for different values of \( \sigma \in \{0, 0.2, 0.4, 0.6, 0.8,
                    1.0\} \):
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Noising Process on MNIST Digits </p>
                </h6>

                <style>
                    .noising-card {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 0.5rem;
                        height: 100%;
                    }

                    .noising-card img {
                        max-width: 100%;
                        height: auto;
                        object-fit: contain;
                    }
                </style>

                <div class="container grid-container border rounded border-2 border-primary-emphasis">
                    <div class="row align-items-center justify-content-center">
                        <div class="col-12 text-center mb-3">
                            <div class="row">
                                <div class="col-2"><strong>\( \sigma = 0.0 \)</strong></div>
                                <div class="col-2"><strong>\( \sigma = 0.2 \)</strong></div>
                                <div class="col-2"><strong>\( \sigma = 0.4 \)</strong></div>
                                <div class="col-2"><strong>\( \sigma = 0.6 \)</strong></div>
                                <div class="col-2"><strong>\( \sigma = 0.8 \)</strong></div>
                                <div class="col-2"><strong>\( \sigma = 1.0 \)</strong></div>
                            </div>
                        </div>

                        <!-- Digit 2 -->
                        <div class="row align-items-center justify-content-center mb-4">
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_0.png" class="card-img-top" alt="Digit 2, =0.0">
                                    <div class="card-body text-center p-1">
                                        <small class="text-muted">Digit 2</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_0_2.png" class="card-img-top"
                                        alt="Digit 2, =0.2">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_0_4.png" class="card-img-top"
                                        alt="Digit 2, =0.4">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_0_6.png" class="card-img-top"
                                        alt="Digit 2, =0.6">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_0_8.png" class="card-img-top"
                                        alt="Digit 2, =0.8">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/2_1.png" class="card-img-top" alt="Digit 2, =1.0">
                                </div>
                            </div>
                        </div>

                        <!-- Digit 3 -->
                        <div class="row align-items-center justify-content-center mb-4">
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_0.png" class="card-img-top" alt="Digit 3, =0.0">
                                    <div class="card-body text-center p-1">
                                        <small class="text-muted">Digit 3</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_0_2.png" class="card-img-top"
                                        alt="Digit 3, =0.2">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_0_4.png" class="card-img-top"
                                        alt="Digit 3, =0.4">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_0_6.png" class="card-img-top"
                                        alt="Digit 3, =0.6">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_0_8.png" class="card-img-top"
                                        alt="Digit 3, =0.8">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/3_1.png" class="card-img-top" alt="Digit 3, =1.0">
                                </div>
                            </div>
                        </div>

                        <!-- Digit 4 -->
                        <div class="row align-items-center justify-content-center mb-4">
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_0.png" class="card-img-top" alt="Digit 4, =0.0">
                                    <div class="card-body text-center p-1">
                                        <small class="text-muted">Digit 4</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_0_2.png" class="card-img-top"
                                        alt="Digit 4, =0.2">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_0_4.png" class="card-img-top"
                                        alt="Digit 4, =0.4">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_0_6.png" class="card-img-top"
                                        alt="Digit 4, =0.6">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_0_8.png" class="card-img-top"
                                        alt="Digit 4, =0.8">
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="card noising-card">
                                    <img src="./images/unet/noising/4_1.png" class="card-img-top" alt="Digit 4, =1.0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <br>

                <p>
                    From the visualization above, increasing the value of \( \sigma \) adds more Gaussian noise to the
                    original MNIST digits. At \( \sigma = 0.0 \), we see the clean original digits. As \( \sigma \)
                    increases, the digits become progressively more noisy, until at \( \sigma = 1.0 \) they resemple
                    pure noise.
                </p>

                <h4 class=""> Part 2.2.1: Training </h4>
                <p>
                    For creating our noisy training data, we use \( \sigma = 0.5\). This means that our model will only
                    learn to denoise noisy data that was generated with \( \sigma = 0.5 \).
                    We initialize the UNet to use a hidden dimension \( D = 128 \) and train the model with the Adam
                    optimizer and a learning rate of \( 1 x 10^{-4}\). We used a batch size of 128 for 5 epochs to get
                    the L2 loss curve shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Denoising Model Performance on MNIST Digits </p>
                </h6>

                <div class="d-flex justify-content-center align-items-center ">
                    <img src="./images/unet/unconditional_unet_training_loss.png"
                        class="img-fluid training-plot p-3 border rounded border-2 border-primary-emphasis"
                        alt="Training Loss Plot">
                </div>
                <br>

                Here are some results from the model after the first and fifth epoch:
                <br> <br>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Denoising Model Performance after first epoch </p>
                </h6>

                <div class="container grid-container">
                    <!-- Column Headers -->
                    <div class="col-12 text-center mb-3">
                        <div class="row justify-content-center">
                            <div class="col-2"><strong>Input</strong></div>
                            <div class="col-2"><strong>Noisy (\( \sigma = 0.5 \))</strong></div>
                            <div class="col-2"><strong>Output</strong></div>
                        </div>
                    </div>

                    <!-- Digit 0 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0.png" class="card-img-top" alt="Input Digit 0">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0_noise.png" class="card-img-top" alt="Noisy Digit 0">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0_epoch_1.png" class="card-img-top"
                                    alt="Output Digit 0">
                            </div>
                        </div>
                    </div>

                    <!-- Digit 5 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5.png" class="card-img-top" alt="Input Digit 5">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5_noise.png" class="card-img-top" alt="Noisy Digit 5">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5_epoch_1.png" class="card-img-top"
                                    alt="Output Digit 5">
                            </div>
                        </div>
                    </div>

                    <!-- Digit 6 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6.png" class="card-img-top" alt="Input Digit 6">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6_noise.png" class="card-img-top" alt="Noisy Digit 6">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6_epoch_1.png" class="card-img-top"
                                    alt="Output Digit 6">
                            </div>
                        </div>
                    </div>
                </div>

                <br>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Denoising Model Performance after fifth epoch </p>
                </h6>

                <div class="container grid-container">
                    <!-- Column Headers -->
                    <div class="col-12 text-center mb-3">
                        <div class="row justify-content-center">
                            <div class="col-2"><strong>Input</strong></div>
                            <div class="col-2"><strong>Noisy (\( \sigma = 0.5 \))</strong></div>
                            <div class="col-2"><strong>Output</strong></div>
                        </div>
                    </div>

                    <!-- Digit 0 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0.png" class="card-img-top" alt="Input Digit 0">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0_noise.png" class="card-img-top" alt="Noisy Digit 0">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/0_epoch_5.png" class="card-img-top"
                                    alt="Output Digit 0">
                            </div>
                        </div>
                    </div>

                    <!-- Digit 5 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5.png" class="card-img-top" alt="Input Digit 5">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5_noise.png" class="card-img-top" alt="Noisy Digit 5">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/5_epoch_5.png" class="card-img-top"
                                    alt="Output Digit 5">
                            </div>
                        </div>
                    </div>

                    <!-- Digit 6 -->
                    <div class="row align-items-center justify-content-center mb-4">
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6.png" class="card-img-top" alt="Input Digit 6">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6_noise.png" class="card-img-top" alt="Noisy Digit 6">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <img src="./images/unet/training/6_epoch_5.png" class="card-img-top"
                                    alt="Output Digit 6">
                            </div>
                        </div>
                    </div>
                </div>

                <br>

                <p class="text-danger"> To DO </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Unconditional UNet Training Loss </p>
                </h6>

                <div class="d-flex justify-content-center align-items-center">
                    <img src="./images/unet/unconditional_unet_training_loss.png"
                        class="img-fluid training-plot border rounded p-2 border-2" alt="Training Loss Plot">
                </div>
                <br>

                <h4 class=""> Part 2.2.2: Out-of-Distribution Testing </h4>

                <p>
                    Note that the model was trained on \( \sigma = 0.5 \) noise. Now, let's see how this denoising model
                    performs and generalizes to other levels of noise.
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Results on digits from the test set with varying noise
                        levels.
                    </p>
                </h6>

                <div class="container p-3 grid-container border rounded border-2 border-primary-emphasis">
                    <div class="row justify-content-center">
                        <!--  = 0.0 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_0.png" class="card-img-top"
                                    alt="Noisy Digit 7, =0.0">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 0.0 \)</p>
                                </div>
                            </div>
                        </div>
                        <!--  = 0.2 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_0_2.png" class="card-img-top"
                                    alt="Noisy Digit 7, =0.2">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 0.2 \)</p>
                                </div>
                            </div>
                        </div>
                        <!--  = 0.4 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_0_4.png" class="card-img-top"
                                    alt="Noisy Digit 7, =0.4">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 0.4 \)</p>
                                </div>
                            </div>
                        </div>
                        <!--  = 0.6 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_0_6.png" class="card-img-top"
                                    alt="Noisy Digit 7, =0.6">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 0.6 \)</p>
                                </div>
                            </div>
                        </div>
                        <!--  = 0.8 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_0_8.png" class="card-img-top"
                                    alt="Noisy Digit 7, =0.8">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 0.8 \)</p>
                                </div>
                            </div>
                        </div>
                        <!--  = 1.0 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_noise_1.png" class="card-img-top"
                                    alt="Noisy Digit 7, =1.0">
                                <div class="card-body">
                                    <p class="card-text text-center">Noisy Image with \( \sigma = 1.0 \)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-center mt-3">
                        <!-- Denoised  = 0.0 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_0.png" class="card-img-top"
                                    alt="Denoised Digit 7, =0.0">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                        <!-- Denoised  = 0.2 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_0_2.png" class="card-img-top"
                                    alt="Denoised Digit 7, =0.2">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                        <!-- Denoised  = 0.4 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_0_4.png" class="card-img-top"
                                    alt="Denoised Digit 7, =0.4">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                        <!-- Denoised  = 0.6 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_0_6.png" class="card-img-top"
                                    alt="Denoised Digit 7, =0.6">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                        <!-- Denoised  = 0.8 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_0_8.png" class="card-img-top"
                                    alt="Denoised Digit 7, =0.8">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                        <!-- Denoised  = 1.0 -->
                        <div class="col-2">
                            <div class="card noising-card">
                                <img src="./images/unet/ood/7_output_1.png" class="card-img-top"
                                    alt="Denoised Digit 7, =1.0">
                                <div class="card-body">
                                    <p class="card-text text-center">Denoised Output</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <br>

                <p class="text-danger"> To Do </p>

            </div>

        </div>

        <div class="3">

            <h1 class="display-6"> Part 3: Training a Diffusion Model </h1>

            <p class="">
                Now, we will train a UNet model that can iteratively denoise an image instead of attempting to denoise
                in a single step.
                Recall that previously we trained the UNet to minimize the loss: \( L = \mathbb{E}_{z, x} || D_\theta(z)
                - x ||^2 \).
                Now, we will change our UNet to predict the added noise \( \epsilon \) instead of the clean image \( x
                \):

                $$ L = \mathbb{E}_{z, x} || \epsilon_\theta(z) - \epsilon ||^2 $$ where \( \epsilon_\theta \) is a UNet
                trained
                to predict noise.

            </p>

            <p>
                The goal of training a diffusion model is to eventaully be able to sample a pure noise image \( \epsilon
                \sim \mathcal{N}(0, 1) \) and generate a realistic image \( x \) from the noise (in this case, an
                MNIST-like image).
                However, we saw in the previous part that one-step denoising does not yield good results.
                Instead, we need to <strong> iteratively </strong> denoise the image for better results.
            </p>

            <p>
                To prepare for training a diffusion model, we first need to define our variance schedule \( \beta \)
                which controlls the amount of noise added at each timestep.
                To do this, we create a list \( \beta \) of \( T \) values where \( \beta_0 = 0.0001\), \( \beta_T =
                0.02 \), and all other elements \( \beta_t \) for \( t \in [1, T-1] \) are evenly spaced between \(
                \beta_0 \) and \( \beta_T \).

                Since the MNIST images are relatively small and simple, we can get by with using a smaller value of \( T
                = 300 \) instead of \( T = 1000 \) which we used when working with DeepFloyd.

                With \( \beta \) defined, we can now define a list \( \alpha \) as \( \alpha_t = 1 - \beta_t \) and a
                list \( \bar{\alpha} \) as \( \bar{\alpha}_t = \prod_{i=1}^t \alpha_i \).

                This allows us to generate noisy images \( x_t \) from \( x_0 \) for any \( t \in [0, T] \) by using the
                equation:
                $$ x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon $$ where \( \epsilon \sim
                \mathcal{N}(0, 1) \).
            </p>

            <p>

                It is important to note that using the previous UNet architecture won't work well for this task because
                it expects the noisy image to have a noise varaince of \( \sigma = 0.5 \).
                Since we are iteratively denoising the image, the variance of \( x_t \) will be different for each
                timestep. While we could solve this issue by training \( T \) separate UNets, a much simpler solution is
                to condition the UNet with timestep \( t \).

                Our final objective then becomes:

                $$ L = \mathbb{E}_{\epsilon, x_0, t} || \epsilon_\theta(x_t, t) - \epsilon ||^2 $$

            </p>

            <div class="3_1" id="section_3_1">

                <h1 class="display-6"> Part 3.1: Adding Time Conditioning to UNet </h1>

                <p>
                    Now we need a way to inject scalar timestep \( t \) into our UNet model to condition it.
                    There are many ways to do this, but we will use the architecture described below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Conditioned UNet architecture</p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/conditional_unet.png" class="img-fluid" alt="Responsive image">
                </div>

                <br>

                <p>
                    The scalar timestep \( t \) is passed through a FC (fully-connected) block to create a vector of
                    length \( D \). This vector is then injected through concatenation.
                    Details of the FC block are shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis">Figure : FC Block </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/fc_block.png" class="img-fluid" alt="Responsive image">
                </div>

                <br>

                <p>
                    Here Linear(F_in, F_out) is a linear layer with F_in input features and F_out output features which
                    is implemented using <code>nn.Linear</code>.
                    Since our conditioning signal \( t \) is a scalar, F_in should be of size 1. It is also recommended
                    to normalize \( t \) to be in the range [0, 1] before embedding it (pass in \( t \) to the linear
                    layer as \( \frac{t}{T} \).)
                </p>


            </div>

            <div class="3_2" id="section_3_2">

                <h1 class="display-6"> Part 3.2: Training the UNet </h1>

                <p>
                    To train the model, we pick a random image from the training set \( x_0 \), a random timestep \( t
                    \), and train the denoiser to predict the noise in \( x_t \). The training algorithm is shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Training time-conditioned UNet</p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/training_alg_time_conditioned_unet.png" class="img-fluid"
                        alt="Responsive image">
                </div>

                <br>

                <p>
                    For this UNet, we set the hidden dimension \( D = 64 \) and train the model with the Adam optimizer
                    with an initial learning rate of \( 1 \text{x} 10^{-4} \), along with an exponential learning rate
                    decay scheduler initialized with \( \gamma = 0.1^{(1/20)} \).
                    Using a batch size of 128, we train the model for 20 epochs.
                    The loss curve is shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Time-Conditioned UNet Training Loss</p>
                </h6>

                <div class="d-flex justify-content-center align-items-center ">
                    <img src="./images/unet/time_conditioned_training_loss.png"
                        class="img-fluid p-3 border rounded border-2 border-primary-emphasis" alt="Responsive image">
                </div>
                <br>
            </div>

            <div class="3_3" id="section_3_3">
                <h1 class="display-6"> Part 3.3: Sampling from the Diffusion Model </h1>

                <p>
                    The sampling process starts with pure noise \( x_T \sim \mathcal{N}(0, 1) \) and iteratively
                    denoises it using our trained model. The sampling algorithm is shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Sampling Algorithm for Time-Conditioned UNet </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/sampling_alg_time_conditioned.png" class="img-fluid"
                        alt="Sampling Algorithm">
                </div>

                <br>

                <p>
                    Let's visualize the sampling process by showing the intermediate denoised images at different
                    timesteps. Below we show the denoising process starting from pure noise and ending with a generated
                    MNIST-like image:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Sampling Process Visualization </p>
                </h6>

                <div class="container grid-container">
                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-8 col-md-8 col-sm-12 mb-4">
                            <div class="card hover-gif">
                                <img src="./images/unet/samples/diffusion_process_final_time_epoch_5.png" class="card-img-top" alt="Epoch 5 Static">
                                <img src="./images/unet/samples/diffusion_process_grid_time_epoch_5.gif" class="card-img-top gif" alt="Epoch 5 Animation">
                                <div class="card-body text-center">
                                    <p class="card-text">Epoch 5 (Hover to see animation)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-8 col-md-8 col-sm-12 mb-4">
                            <div class="card hover-gif">
                                <img src="./images/unet/samples/diffusion_process_final_time_epoch_20.png" class="card-img-top" alt="Epoch 20 Static">
                                <img src="./images/unet/samples/diffusion_process_grid_time_epoch_20.gif" class="card-img-top gif" alt="Epoch 20 Animation">
                                <div class="card-body text-center">
                                    <p class="card-text">Epoch 20 (Hover to see animation)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <div class="3_4" id="section_3_4">
                <h1 class="display-6"> Part 3.4: Adding Class-Conditioning to UNet </h1>

                <p>
                    To better control image generation, we can condition the UNet on the class of digit \( \in \{0, 1,
                    2, 3, 4, 5, 6, 7, 8, 9\} \).
                    To do this, we represent the class as a one-hot encoded vector \( c \) of size 10. This signal gets
                    propagated through the network with the help of two additional fully-connected blocks.
                    Additionally, we implement dropout with a 10% probability of zeroing out the one-hot encoded vector;
                    this is done so that the model can still work without being conditioned on the class label.

                    Below is the updated training algorithm:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Training Algorithm for Class-Conditioned UNet </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/class_conditioned_training_alg.png" class="img-fluid"
                        alt="Sampling Algorithm">
                </div>

                <p>
                    Using the same hyperparameters as the time-conditioned UNet, we train the model and plot the loss
                    curve below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Class-Conditioned UNet Training Loss </p>
                </h6>

                <div class="d-flex justify-content-center align-items-center ">
                    <img src="./images/unet/class_conditioned_training_loss.png"
                        class="img-fluid p-3 border rounded border-2 border-primary-emphasis" alt="Responsive image">
                </div>
                <br>

            </div>

            <div class="3_5" id="section_3_5">
                <h1 class="display-6"> Part 3.5: Sampling from the Class-Conditioned UNet </h1>

                <p>
                    To sample from the class-conditioned UNet, we will use the same technique from part A of this
                    project. We saw before that conditional results aren't good unless we use classifier-free guidance.
                    Therefore, we use classifier-free guidance with \( \gamma = 5 \).
                    The algorithm for sampling is shown below:
                </p>

                <h6>
                    <p class="text-primary-emphasis"> Figure : Sampling Algorithm for Class-Conditioned UNet </p>
                </h6>

                <div class="mx-auto w-75 p-3 border rounded border-2 border-primary-emphasis">
                    <img src="./images/unet/class_conditioned_sampling_alg.png" class="img-fluid"
                        alt="Responsive image">
                </div>
                <br>

            </div>

            <div class="conclusion">
                <h1 class="display-6"> Conclusion </h1>

                <p>
                    In this project, we successfully implemented and trained a diffusion model on the MNIST dataset. We
                    demonstrated:
                <ul>
                    <li>The limitations of one-step denoising</li>
                    <li>How to condition a UNet on timesteps</li>
                    <li>The iterative sampling process for generating new images</li>
                    <li>Various properties of diffusion models including interpolation</li>
                </ul>
                The results show that even with a relatively simple architecture and a small number of timesteps
                (T=300), we can generate high-quality MNIST-like digits using the diffusion process.
                </p>
            </div>

        </div>

        <hr>

        <div class="project-insight">
            <h1 class="display-6"> Neural Style Transfer Insights </h1>
            <p class="lead">
                I enjoyed learning how to re-implement the paper <a href="https://arxiv.org/pdf/1508.06576.pdf">
                    <i>A
                        Neural Algorithm of Artistic Style</i> </a> from scratch! It was a very valuable experience
                having to dissect the paper and take in all of the information provided by the authors. Implementing
                this project was also fun since I had the chance to use some of my own images!
            </p>
        </div>

    </div>

</body>

</html>