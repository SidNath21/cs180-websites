<!DOCTYPE html>
<html>

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title> Final Project - CS180 </title>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

</head>

<body>

    <div class="main-description mt-3">

        <h1 class="display-3 text-center"> CS 180 - Final Project </h1>
        <p class="lead text-center fs-3"> Image Quilting & A Neural Algorithm of Artistic Style </p>
        <p class="text-center fs-4"> Siddharth Nath - <span>sidnath@berkeley.edu</span> </p>
        <div style="width: 80%;" class="mx-auto">
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <button class="btn btn-outline-primary me-md-2" type="button" onClick="document.getElementById('image-quilting').scrollIntoView();""> Image Quilting </button>
                <button class="btn btn-outline-primary" type="button" onClick="document.getElementById('neural-style-transfer').scrollIntoView();"> Neural Algorithm of Artistic Style </button>
            </div>
            <hr />
            <!-- <div id="carouselExample" class="carousel slide">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="./imageQuilting/samples/bricks_small.jpg" class="d-block w-100" alt="...">
                    </div>
                    <div class="carousel-item">
                        <img src="./imageQuilting/samples/bricks_small.jpg" class="d-block w-100" alt="...">
                    </div>
                    <div class="carousel-item">
                        <img src="./imageQuilting/samples/bricks_small.jpg" class="d-block w-100" alt="...">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div> -->
        </div>

    </div>


    <div class="project-body mx-auto" style="width: 80%;">

        <div class="project-overview" id="image-quilting">
            <h1 class="display-5"> Image Quilting Overview </h1>
            <p class="lead">
                In this assignment I learned about the different methods I can use for texture synthesis and texture
                transfer.
                Texture synthesis descibes generating a larger texture image from a smaller sample while texture
                transfer is the process of giving an object the appearance of having a specific texture while
                maintaining the object's basic shape.
                This project follows the implementation of the paper <a
                    href="https://www2.eecs.berkeley.edu/Research/Projects/CS/vision/papers/efros-siggraph01.pdf">
                    <i>Image Quilting for Texture Synthesis and Transfer</i> </a> which required me to familiarize
                myself with the paper and implement the methods descibed.
                The three methods I implemented for texture synthesis are:
            </p>
            <ol>
                <li> Randomly Sampled Texture </li>
                <li> Overlapping Patches </li>
                <li> Seam Finding </li>
            </ol>
            <p class="lead">
                For the texture transfer, I used the Seam Finding method as it performed better than the other two.
            </p>
        </div>

        <div class="1_1">
            <h1 class="display-6"> Part 1.1: Texture synthesis - Randomly Sampled Texture </h1>
            <p>

                The most naive way to do texture synthesis is by randomly sampling square patches from the smaller
                sample texture in order to create the output image of a given size.
                For this I implemented the function <code>quilt_random(sample, out_size, patch_size)</code> that creates
                an output image of size <code>out_size</code> by tiling square patches of size <code>patch_size</code>
                from the <code>sample</code> texture.
                <br> <br>
                Here are the results of this method:
            </p>

            <h5> Results </h5>
            <p> Below I listed the input textures and larger output textures </p>

            <div class="container grid-container">

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/samples/bricks_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Brick Sample </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/samples/text_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Text Sample </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/samples/white_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> White Sample </p>
                            </div>
                        </div>
                    </div>



                </div>
            </div>


            <div class="container grid-container">

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/naive_bricks_small.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_random(sample, 300, 30)</code> </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/naive_text_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_random(sample, 300, 30)</code> </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/naive_white_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_random(sample, 300, 30)</code> </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>


        <div class="1_2">
            <h1 class="display-6"> Part 1.2: Texture synthesis - Overlapping Patches </h1>
            <p>
                A better approach for texture synthesis is to have the sampled patches overlap with the existing ones
                along the edges of the patches.
                After sampling a random patch to be the top-left corner, I sample new patches that overlap with the
                existing ones by choosing the patch that has the minimum cost over the overlapping region.
                For this I implemented the function
                <code>quilt_simple(sample, out_size, patch_size, overlap, tol)</code> that samples new patches of size
                <code>patch_size</code> that overlap with the existing patches by <code>overlap</code> pixels.
                By computing the SSD cost across the overlapping region for every possible patch of size
                <code>patch_size</code> from the input image, I select a random patch with low cost out of the
                <code>tol</code> lowest-cost patches.
                <br> <br>

            </p>

            <h5> Results </h5>
            <p> Below I listed the input textures and larger output textures </p>

            <div class="container grid-container">

                <div class="row align-items-center justify-content-center">

                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/simple_bricks_small.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_simple(sample, 300, 45, 9, 3)</code> </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/simple_text_small.jpg" class="card-img-top" alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_simple(sample, 300, 45, 9, 3)</code> </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/simple_white_small.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>quilt_simple(sample, 300, 45, 9, 3)</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <p>
                Here we can see that the results are much better than the naive approach! The synthesized textures look
                more coherent and overall they have less artifacts than the ones generated by the naive approach.
            </p>

            <div class="1_1">
                <h1 class="display-6"> Part 1.3: Texture synthesis - Seam Finding </h1>
                <p class="">
                    This method is an extension of the overlapping patches method but instead of naively overlapping the
                    new sampled patch on top of the existing patches, this method finds the minimum SSD cost of a
                    contiguous path from the left to right side of the patch.
                    For this, I implemented the function
                    <code>quilt_cut(sample, out_size, patch_size, overlap, tol)</code> Samples square patches of size
                    <code>patch_size</code> from <code>sample</code> using seam finding on the overlapping regions in
                    order to create an output image of size <code>out_size</code>.
                </p>

                <h5> Results </h5>
                <p> Below I listed the input textures and larger output textures </p>

                <hr>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/better_bricks_small.jpg" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>quilt_cut(sample, 300, 45, 9, 5)</code> </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/better_text_small.jpg" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>quilt_cut(sample, 300, 45, 9, 5)</code> </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/better_white_small.jpg" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>quilt_cut(sample, 300, 45, 9, 5)</code> </p>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <p>
                    Although the improvements are less noticeable, the resulting textures are more visually pleasing as
                    they contain less artifacts! The improvement is most noticeable with the white texture as the edges
                    are not as distinct and noticable as the previous overlapping patches method. Additionally, the text
                    is better aligned and more legible than before.
                </p>


            </div>

            <div class="1_1">
                <h1 class="display-6"> Part 2: Texture Transfer </h1>
                <p class="lead">
                    The next part of this project involved using the seam finding texture synthesis method to create a
                    texture sample that is guided by a pair of sample/target correspondence images.
                    The end result is an output image of the same shape/structure as the target image in the style of
                    the sample texture image.
                    The paper mentions that we need to define a "correspondence map" to compute the difference between
                    the texture image and the target image. For this project, I opted to use the blurred gray-scale
                    versions of the target and texture to compare the two images.
                    For this I implemented a function
                    <code>texture_transfer(sample, patch_size, overlap, tol, guidance_im, alpha)</code> that follows the
                    same logic as the seam finding function. The main difference is that now I have to use
                    <code>guidance_im</code> to determine the shape of the output while using <code>sample</code> to
                    determine the style/texture of the output image. To account for this change, I modified the cost
                    function that is used to search for next patch to sample. The new cost function is now:
                    $$ \alpha * [\text{SSD of Overlapping Region}] + (1 - \alpha) * [\text{difference of texture (sample) patch & the target (guidance_im) patch} ] $$
                    By carefully weighting the <code>alpha</code> parameter along with <code>patch_size</code>, I got
                    the following results:
                </p>

                <hr>
                <h5> Results </h5>
                <p> Below I listed the sample textures, the corresponding target image, and the final output image </p>

                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/sketch.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Source Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_texture.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/feynman.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Target Image </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_target.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Source </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>



                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/sketch_feynman_transfer.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>texture_transfer(sample, 27, 4, 1, guidance_image, 0.5)</code> </p>
                            </div>
                        </div>
                    </div>
                </div>


                <hr>


                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/rocks.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Source Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_texture_2.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/sid_small.jpeg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Target Image </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_target_2.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Source </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>



                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/rocks_sid_small_transfer.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>texture_transfer(sample, 17, 5, 1, guidance_image, 0.5)</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <hr>
                
                <div class="container grid-container">

                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/white_small.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Source Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_texture_3.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Texture </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/samples/avocado.jpeg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Target Image </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/blur_target_3.jpg" class="card-img-top" alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> Correspondence Map - Source </p>
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="row align-items-center justify-content-center">
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                            <div class="card">
                                <img src="./imageQuilting/results/white_small_avocado_transfer.jpg" class="card-img-top"
                                    alt="Image 1">
                                <div class="card-body text-center">
                                    <p class="card-text"> <code>texture_transfer(sample, 15, 4, 1, guidance_image, 0.7)</code> </p>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

            <div class="project-insight">
                <h1 class="display-6"> Bells & Whistles: Texture Transfer + Blending </h1>
                <p class="lead">
                    To get more satisfying results, I decided to use a combination of texture transfer and blending to create a face-in-toast image. 
                    To accomplish this I utilized the Laplacian pyramid blending methods that I implemented in Project 2.
                </p>

                <p>
                    I started by first cropping the white edges from the border of the orignal toast image so the white borders wouldn't be sampled during the texture transfer. 
                    Using the cropped toast image as the source texture and Vishali as the target image, I ran the <code>texture_transfer</code> method and got the following output:
                </p>

                <hr>


                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/samples/toast.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Sample Toast </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/samples/vishali_face_2.jpeg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Target Face </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/toast_vishali_face_2_transfer.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> <code>texture_transfer(cropped_sample, 27, 4, 1, guidance_image, 0.5)</code> </p>
                            </div>
                        </div>
                    </div>
                </div>


                Given this output, we can define a binary mask on the original toast image and use that for our Laplacian blending between the original toast and the result of the texture transfer method:
                <br> <br>
                <h5>Results:</h5>

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/mask.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Original Binary Mask </p>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/mask.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Target Face </p>
                            </div>
                        </div>
                    </div> -->
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./imageQuilting/results/face-in-toast.jpg" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Face-In-Toast! </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <div class="project-insight">
                <h1 class="display-6"> Image Quilting Insights </h1>
                <p class="lead">
                    I really enjoyed completing this project and learning more about how I can implement image quilting from scratch. My favorite part was reading through the paper and seeing the results of the texture transfer on my own images.
                </p>
            </div>
        </div>

        <hr>

        <div class="project-overview" id = "neural-style-transfer">
            <h1 class="display-5"> Neural Algorithm of Artistic Style Overview </h1>
            <p class="lead">
                This project involved reimplementing the paper <a
                    href="https://arxiv.org/pdf/1508.06576.pdf"> <i>A Neural Algorithm of Artistic Style</i> </a>! 
                The paper explains how to use Convolutional Neural Networks - specifically the VGG-19 architecture - to capture the content and style of a given image.     
                The key finding of this paper is that representations of content and style in the CNN are separable; therefore, we can manipulate both representations independently to perform style transfering.
            </p>
        
        </div>

        <div class="1_1">
            <h1 class="display-6"> Part 1: Modifying VGG-19 Architecture</h1>
            <p class="lead">
                The first step in this project involved downloading the pretrained VGG-19 CNN model to use for this task. The paper uses the feature space provided by the 16 convolutional and 5 pooling layers of the 19 layer VGG-Network. 
                However, the authors do no use any of the fully connect layers and they opt to replace the max-pooling operations with average pooling to improve performance. 
                <hr>
                <br>

                <div class="mx-auto w-75">
                    <img src="./neuralStyleTransfer/images/vgg_network2.png" class="img-fluid" alt="Responsive image">
                </div>
                <br>

                <p>
                    The pretrained VGG-Network contains two different <code>Sequential</code> PyTorch implementations: features (containing the convolution and pooling layers), and classifier (containing fully connected layers). Since we we need the output of the individual convolution layers to measure the content and style loss, we use the features module!
    
                    To extract the content and style representations from the CNN, the authors recommends using the feature output of convolutional layer 4_2 to learn the "content" of the image, while using output of layers 1_1, 2_1, 3_1, 4_1, and 5_1 to learn the "style" of the image.
                    Since I only need the outputs from these 6 convolutional layers, I modified the <code>forward()</code> function of my VGG model to return only those responses.
                </p>

                <p>
                    The initial and modified network architecture after renaming layers and changing the max-pooling operations to avg-pooling is shown below:
                </p>

                <div class="row align-items-center justify-content-center">
                    <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./neuralStyleTransfer/images/initial_model.png" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Pretrained Architecture </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
                        <div class="card">
                            <img src="./neuralStyleTransfer/images/modified_model.png" class="card-img-top"
                                alt="Image 1">
                            <div class="card-body text-center">
                                <p class="card-text"> Modified VGG-19 Architecture </p>
                            </div>
                        </div>
                    </div>
                </div>

            </p>
        </div>

        <div class="1_1">
            <h1 class="display-6"> Part 2: Defining Loss Functions </h1>
            <p class="lead">
                Since the paper separates the content and style representations of images, we have two loss functions that we use when training the modified VGG-19 network. 
                In other words, the loss function that we aim to minimize contains two terms: one for content and another for style!
            </p>
        </div>

        <hr>
        <p>
            
        </p>
        <h5> Content Loss </h5>

        <p>
            The authors of the paper realized that using the feature representation at convolution layer 4_2 was the most effective in representing the content of the image. 
            However, this is a parameter that can be tuned to get different results since higher layers in the network capture the high-level content of an image while lower layers reproduce exact pixel values of the original image.
        </p>

        <p>
            To calculate the content loss of the content image with respect to the image we are generating, we use the outputs of convolutional layer 4_2 in the equation below:
        </p>


        <div class="mx-auto">
            <img src="./neuralStyleTransfer/images/content_loss.jpg" alt="Responsive image">
        </div>


        <p>
            Here, the content loss is simply the Mean Squared Error (MSE) between \( F \) (the 4_2 feature map of the generated image) - and \( P \) (the 4_2 feature map of the content image)
        </p>

        <h5> Style Loss </h5>

        <p>
            Calculating the style loss is not as simple as the content loss. To capture the "style" of an image, we first build a style representation from the feature maps that calculated the correlations between the different feature responses. This is done by calculating the Gram Matrix - the inner product between the vectorized feature maps. 
        </p>

        <div class="mx-auto">
            <img src="./neuralStyleTransfer/images/gram_matrix.jpg" alt="Responsive image">
        </div>

        <p>
            After computing the Gram matricies for each vectorized feature map, we cstart by minimizing the mean-squared distance between the entries of the Gram matrix from the original image and the Gram matrix of the image to be generated. For a given layer l, the contribution of that layer to the style loss is defined as:
        </p>

        <div class="w-75">
            <img src="./neuralStyleTransfer/images/style_error.jpg" class="img-fluid" alt="Responsive image">
        </div>

        <p>
            By aggregating this error across all the convolutional layers, we get the total style loss which is equal to:
        </p>

        <div class="w-75">
            <img src="./neuralStyleTransfer/images/style_loss.jpg" class="img-fluid" alt="Responsive image">
        </div>

        <p>
            In the equation above, \( w_{l} \) represents the weight of the contribution of each layer to the total loss. For this implementation, I set \( w_{l} = 1/5 \) for convolutional layers 1_1, 2_1, 3_1, 4_1, and 5_1. For any other layers, \( w_{l} = 0\)
        </p>

        <h5> Total Loss </h5>
        <p>
            Combining the Style Loss with the Content Loss, the total loss we minimize is: 
            $$
            \LARGE{
                L_{total} (\vec{p}^{\,}, \vec{a}^{\,}, \vec{x}^{\,}) = \alpha * L_{content}(\vec{p}^{\,}, \vec{x}^{\,}) + \beta * L_{style}(\vec{a}^{\,}, \vec{x}^{\,})
            }
            $$
        </p>
        <p>
            Here, \(\alpha\) and \(\beta\) are parameters that control the weighting factors for content (\( \alpha \)) and style (\( \beta \)).
        </p>

        <div class="1_1">
            <h1 class="display-6"> Part 3: Training & Results </h1>
            <p class="">
                To train this model and optimize the loss function, it is important to performing some preprocessing steps to get the best results. 
            </p>
            <p>
                Firstly, we need to resize the images to the appropriate size; since I have access to Google Colab's GPU compute power, I resized the content and style images to 512 by 512 pixels. 
                Additionally, we have to convert this resized image of shape (height, width, channel size) into (batch size, channel size, height, width) so that our images are compatible with the VGG-19 architecture!
                When downloading the pretrained model, it is also important to set the network to evaluation mode using <code>.eval()</code> since some of the model's layers have different behavior during training vs evaluation.
            </p>
        </div>

        <hr>
        <h5> Training </h5>

        <p>
            For training, I decided to use the Adam optimizer initialized with a learning rate of 0.004 - the paper did not specify what optimizer to use but using the Adam optimizer turned out fine.
            The paper also mentions that the ratio \(\alpha / \beta \) was either \( 1 * 10^{-3} \text{ or } 1 * 10^{-4}\). Therefore, I started off by setting \( \alpha = 1 \) and \( \beta = 1000 \).
            In the paper, the authors initialize a randomized white-noise image to be the image that is getting optimized. However, I got better results by initializing the image-to-be-generated with a copy of the content image.
        </p>

        <p>
            After only 300 training iterations (optimizer steps), I got the following results: 
        </p>

        <h5> Results </h5>        

        <div class="row align-items-center justify-content-center">

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/content/dancing.jpeg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Content </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/style/picasso.jpeg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Style </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/results/dancing_picasso.jpg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Output </p>
                    </div>
                </div>
            </div>
        </div>

        <p>
            Content Image of a Balerina in the style of <i>Femme nue assise</i> by Pablo Picasso! The content image was taken from <a href="https://pytorch.org/tutorials/advanced/neural_style_tutorial.html">this</a> PyTorch resource. The results turned out pretty good but we lose many of the high frequency details of the ballerina. I tried fine-tuning different parameters such as the number of style layers and the \(\alpha \text{ and } \beta \) values but it did not make much improvement!
        </p>
        
        <hr>

        <div class="row align-items-center justify-content-center">

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/content/berkeley.jpeg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Content </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/style/starry_night.jpg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Style </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/results/berkeley_starry_night.jpg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Output </p>
                    </div>
                </div>
            </div>
        </div>


        <p>
            This result blends a photo of Berkeley that I took with the style of <i>The Starry Night</i> by Vincent van Gogh!
        </p>

        

        <hr>

        <div class="row align-items-center justify-content-center">

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/content/dc.jpeg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Content </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/style/scream.jpg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Style </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <img src="./neuralStyleTransfer/images/results/dc_scream.jpg" class="card-img-top" alt="Image 1">
                    <div class="card-body text-center">
                        <p class="card-text"> Output </p>
                    </div>
                </div>
            </div>
        </div>

        <p>
            This final result combines a photo that I took of Vishali with the style of <i>Der Schrei</i> by Edvard Munch. Similar to the first example, many smaller details of the face & body are lost as a result of this style transfer. In my notebook, I tried varying some of the parameters and I even set the \( \alpha:\beta \) ratio to \(1 * 10^{-2}\) but it didn't make a big difference!
        </p>


        <div class="project-insight">
            <h1 class="display-6"> Neural Style Transfer Insights </h1>
            <p class="lead">
                I enjoyed learning how to re-implement the paper <a
                href="https://arxiv.org/pdf/1508.06576.pdf"> <i>A Neural Algorithm of Artistic Style</i> </a> from scratch! It was a very valuable experience having to dissect the paper and take in all of the information provided by the authors. Implementing this project was also fun since I had the chance to use some of my own images!
            </p>
        </div>

    </div>

</body>

</html>